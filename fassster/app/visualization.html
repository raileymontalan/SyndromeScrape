<link rel="stylesheet" type="text/css" href="assets/plugins/ionslider/ion.rangeSlider.css" />
<link rel="stylesheet" type="text/css" href="assets/plugins/ionslider/ion.rangeSlider.skinModern.css" />

<div id="diseaseSelector" class="panelSelector">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" id="diseaseName" class="btn btn-default xl labeler">Disease Selector</button>
        <button type="button" class="btn btn-default openPanel xl"> <i class="glyphicon glyphicon-modal-window"></i> </button>
    </div>
    <div class="panel-group" id="accordion">
        <div class="panel panel-default padded projectList" id="projectList">
          <div data-template="data-template">
            <div class="panel-heading" role="tab" id="heading{{ id }}">
                <h4 class="panel-title">
                    <a class="collapsed pTitle" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse{{ id }}" aria-expanded="false" aria-controls="collapse{{ id }}">
                    {{ title }}
                    </a>
                </h4>
						</div>
						
            <div id="collapse{{ id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading{{ id }}">
              <div class="panel-body noborder">
                <div class="panel-group" id="accordion{{ id }}">

									<div class="panel panel-inner panel-default"  data-template-for="scenarios">
								
										<div class="panel-heading" role="tab" id="heading{{ sid }}">
											<h4 class="panel-title">
												<a class="collapsed sTitle" role="button" data-toggle="collapse" data-parent="#accordion{{ _parent.id }}" href="#collapse{{ sid }}" aria-expanded="false" aria-controls="collapse{{ sid }}">
												<i class="glyphicon glyphicon-chevron-right"></i> {{ title }}
												</a>
											</h4>
										</div>
										<div id="collapse{{ sid }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading{{ sid }}">
											<div class="list-group">
												<a class="list-group-item indent startSim" id="S_{{ sid }}" name="{{ title }}-Susceptible" href="#">Susceptible</a>
												<a class="list-group-item indent startSim" id="E_{{ sid }}" name="{{ title }}-Exposed" href="#">Exposed</a>
												<a class="list-group-item indent startSim" id="I_{{ sid }}" name="{{ title }}-Infectious" href="#">Infectious</a>
												<a class="list-group-item indent startSim" id="R_{{ sid }}" name="{{ title }}-Recovered" href="#">Recovered</a>
											</div>
										</div>
									</div>
                </div>
              </div>
						</div>
						
          </div>  
        </div>
    </div>
</div>

<div id='mapid'></div>

<div id="slider" style="display: none;">
		<button id='play'><i class="fa fa-play-circle fa-3x"></i></button>
		<input id="myRange" type="text" data-type="single" data-step="1" data-from="1" data-slider="true" data-hasgrid="true" />
</div>

<div class="modal-loading">
		<!-- Place at bottom of page -->
		<i class="fa fa-refresh fa-spin fa-3x fa-fw margintop100"></i>
</div>

<script src="assets/plugins/ionslider/ion.rangeSlider.js" ></script>
<script src="assets/plugins/moment/moment.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

	$('#mapid').css('height', $(window).height()-60 );

	var body = {};
	cData = [];
	cScenario = [];
	//var promise = $.post("http://fassster.ehealth.ph/web_api/emr",
	var promise = $.post("http://www.romeljohnsantos.com/api/projects.php?id=all",
	body, function(data) {
				if(data) {
						$.each(data, function(i, item) {
								cData.push({
										id: item.id,
										date: new Date(item.date),
										title: item.title,
										author: item.author,
										image: item.image,
										description: item.description,
										scenarios: item.scenarios
								});
						});
				}
		}, "json");

	promise.done(function() {
			console.log(cData);
			//display data using template plugin
			Tempo.prepare("projectList").render(cData);

			var playStatus
			var playButton = document.getElementById("play");
			$('#play').on('click', function(){
				if (playButton.innerHTML == '<i class="fa fa-play-circle fa-3x"></i>'){
					playButton.innerHTML = '<i class="fa fa-dot-circle-o fa-3x"></i>';
					playStatus = true;
					playLoop();
				}else{
					playButton.innerHTML = '<i class="fa fa-play-circle fa-3x"></i>';
					playStatus = false;
				}
			});
			
			$('a.startSim').on('click', function(e){ 
				e.preventDefault();
				$('.modal-loading').css('display','block');
				//get ID of this button
				var aID = $(this).attr('id');
				//get name of this button
				var aName = $(this).attr('name');
				//assign name to the Console bar
				$("#diseaseName").html(aName);
				requestData(aID);

				mymap.setView(new L.LatLng(11.1, 121.9),8);
				$('#diseaseSelector .panel-default').slideUp();
				//$('.openPanel').show('slide',{direction:'left'});
				$('.openPanel').addClass('clickable');
				$('.openPanel i.glyphicon').removeClass('glyphicon-modal-window');
				$('.openPanel i.glyphicon').addClass('glyphicon-collapse-down');
				$( "#slider" ).show();
				//$('#play').show();
				$('.modal-loading').css('display','none');
			});

			$('.openPanel').on('click', function(){
				if($(this).hasClass('clickable')) {
					$('#diseaseSelector .panel-default').slideDown();
					//$('.openPanel').hide('slide',{direction:'left'});
					$('.openPanel').removeClass('clickable');
					$('.openPanel i.glyphicon').removeClass('glyphicon-collapse-down');
					$('.openPanel i.glyphicon').addClass('glyphicon-modal-window');
					$( "#slider" ).hide();
				}
			});
			//document.getElementById("myRange").value = "0";
			//This activates the slider
			//use the functions to create interactivity on the map
			//the onChange is the best function to use for color changes
			$("#myRange").ionRangeSlider({
				grid: true,
				grid_num: 30,
				grid_snap: true,
				prettify_enabled: true,
				keyboard: true,
			});
			mapslider = $("#myRange").data("ionRangeSlider");
			//cloner();
					
			$('.preloader').hide();
	});

});

//fire map rendering
var dataType, counts, grades, date_length, disease, compartment;
var dataLayer = L.layerGroup();
var osmMapnik = new L.tileLayer.provider("OpenStreetMap.Mapnik");
var stamenTerrain = new L.tileLayer.provider("Stamen.Terrain");
var osmBW = new L.tileLayer.provider("OpenStreetMap.BlackAndWhite");
var stamenToner = new L.tileLayer.provider("Stamen.Toner");
var mapboxTile = new L.tileLayer.provider("MapBox", {
	id: 'jenjereren.16nj7dd6',
	accessToken: 'pk.eyJ1IjoiamVuamVyZXJlbiIsImEiOiJjaXM2ODlkNmcwZDlnMnlvMGswNmpldWUwIn0.eCh8h5prpNCamLH_zbYHoA'
});

var mymap = new L.Map("mapid", {
	center: new L.LatLng(12.4, 122.4),
	zoomControl: false,
	zoom: 5.5,
	minZoom: 2,
	maxZoom: 12,
	layers: [osmBW]
});
var baseLayers = {
	"Stamen Terrain": stamenTerrain,
	"Stamen Toner": stamenToner,
	"Mapbox": mapboxTile,
	"OpenStreetMap": osmMapnik,
	"OpenStreetMap B&W": osmBW
};
var controlLayers = L.control.layers(baseLayers).addTo(mymap);
var legend = L.control({position: 'topright'});
// adds a scale bar to the map in metric and English units
L.control.scale().addTo(mymap);

function playLoop () {
	setTimeout(function () {
		if (playStatus){
			if (dataType == "STEM"){
				sliderDate = $("#myRange").prop("value");
				var i = counts.time.indexOf(sliderDate);
				if (i<date_length-1){
					mapslider.update({
						from: i+1,
					});
					i++;
					playLoop();
				} else {
					mapslider.update({
						from: 0,
					});
					playButton.innerHTML = '<i class="fa fa-play-circle-o"></i>';
				}
			}
		}
	}, 500)
}
//render STEM compartment data
function requestData(type) {
	//remove overlayed layers and popups
	compartment = type.split("_")[0];
	dataLayer.clearLayers();
	mymap.closePopup();
	STEM_url = "data?aID=" + type
	dataType = "STEM";
	$.getJSON(STEM_url, function(data) {
		counts = data.data;
		grades = data.grades;
		date_length = data.date_length;
		
		// Call sliders update method with any params
		mapslider.update({
			values: counts.time,
			from: 0,
			onStart: function (data) {
			//console.log(data);
			},
			onChange: function (data) {
				dataLayer.getLayers()[0].setStyle(STEMstyle);
				//update popup values
				dataLayer.getLayers()[0].eachLayer(function (layer) {
					sliderDate = $("#myRange").prop("value");
					slidervalue = counts.time.indexOf(sliderDate);
					if (counts[layer.feature.properties.loc_cd] != null){
						var count = counts[layer.feature.properties.loc_cd][slidervalue];
					}
					//format popup text
					var textList = layer.feature.properties.loc_cd.split("_");
					var msg = "<b>Province: </b>" + textList[1] + "<br/>";
					msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
					msg += "<b>Count: </b>";
					msg += count ? count : (count==0) ? count : "No Data";
					layer._popup.setContent(msg);
				});
				//PHgeojson.setStyle(STEMstyle);
			},
			onFinish: function (data) {
				//console.log(data);
			},
			onUpdate: function (data) {
				//console.log(data);
				if (dataLayer.getLayers()[0]){
					dataLayer.getLayers()[0].setStyle(STEMstyle);
					//update popup values
					dataLayer.getLayers()[0].eachLayer(function (layer) {
						sliderDate = $("#myRange").prop("value");
						slidervalue = counts.time.indexOf(sliderDate);
						if (counts[layer.feature.properties.loc_cd] != null){
							var count = counts[layer.feature.properties.loc_cd][slidervalue];
						}
						//format popup text
						var textList = layer.feature.properties.loc_cd.split("_");
						var msg = "<b>Province: </b>" + textList[1] + "<br/>";
						msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
						msg += "<b>Count: </b>";
						msg += count ? count : (count==0) ? count : "No Data";
						layer._popup.setContent(msg);
					});
				}
			}
		});
		//PHgeojson.setStyle(STEMstyle);
		renderSTEMPH()
		addLegend();
	});
	function renderSTEMPH(){
		STEMPH_url = "assets/geojson/STEMPhil.geojson"
		$.getJSON(STEMPH_url, function(data) {
			var geojsonlayer = {};
			STEMgeojsonlayer = L.geoJson(
				data, { onEachFeature: onEachSTEMFeature, style: STEMstyle }
			);
			dataLayer.clearLayers();
			mymap.closePopup();
			dataLayer.addLayer(STEMgeojsonlayer);
			dataLayer.addTo(mymap);
		});

		function onEachSTEMFeature(feature, layer) {
			var STEMpopup = L.popup();
			sliderDate = $("#myRange").prop("value");
			slidervalue = counts.time.indexOf(sliderDate);
			if (counts[feature.properties.loc_cd] != null){
				var count = counts[feature.properties.loc_cd][slidervalue];
			}
			//format popup text
			var textList = layer.feature.properties.loc_cd.split("_");
			var msg = "<b>Province: </b>" + textList[1] + "<br/>";
			msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
			msg += "<b>Count: </b>";
			msg += count ? count : (count==0) ? count : "No Data";
			layer.bindPopup(msg);
		}
	}
}

// get color depending on count
function STEMgetColor(mun) {
	sliderDate = $("#myRange").prop("value");
	slidervalue = counts.time.indexOf(sliderDate);
	//console.log(value);
	if (counts[mun] != null){
		var count = counts[mun][slidervalue];
	}
	if (compartment == "R"){
		return count >= grades[7] ? '#005a32' :
		count >= grades[6] ? '#238b45' :
		count >= grades[5] ? '#41ab5d' :
		count >= grades[4] ? '#74c476' :
		count >= grades[3] ? '#a1d99b' :
		count >= grades[2] ? '#c7e9c0' :
		count >= grades[1] ? '#e5f5e0' :
		count >= grades[0] ? '#f7fcf5' :
		'#ccc';
	} else if (compartment == "I"){
		return count >= grades[7] ? '#ac1016' :
		count >= grades[6] ? '#d32020' :
		count >= grades[5] ? '#f14431' :
		count >= grades[4] ? '#fb7050' :
		count >= grades[3] ? '#fc9677' :
		count >= grades[2] ? '#fcbda4' :
		count >= grades[1] ? '#fee0d3' :
		count >= grades[0] ? '#fff5f0' :
		'#ccc';
	} else if (compartment == "E"){
		return count >= grades[7] ? '#e9791a' :
		count >= grades[6] ? '#f78e24' :
		count >= grades[5] ? '#fea43b' :
		count >= grades[4] ? '#febb60' :
		count >= grades[3] ? '#fed384' :
		count >= grades[2] ? '#fee3a1' :
		count >= grades[1] ? '#fef1ba' :
		count >= grades[0] ? '#ffffd4' :
		'#ccc';
	} else if (compartment == "Tweets"){
		return count >= grades[7] ? '#084594' :
		count >= grades[6] ? '#2171b5' :
		count >= grades[5] ? '#4292c6' :
		count >= grades[4] ? '#6baed6' :
		count >= grades[3] ? '#9ecae1' :
		count >= grades[2] ? '#c6dbef' :
		count >= grades[1] ? '#deebf7' :
		count >= grades[0] ? '#f7fbff' :
		'#ccc';
	} else{
		return count >= grades[7] ? '#084594' :
		count >= grades[6] ? '#2171b5' :
		count >= grades[5] ? '#4292c6' :
		count >= grades[4] ? '#6baed6' :
		count >= grades[3] ? '#9ecae1' :
		count >= grades[2] ? '#c6dbef' :
		count >= grades[1] ? '#deebf7' :
		count >= grades[0] ? '#f7fbff' :
		'#ccc';
	}
}
function STEMstyle(feature) {
	return {
		weight: 0.7,
		opacity: 0.7,
		color: 'gray',
		fillOpacity: 0.75,
		fillColor: STEMgetColor(feature.properties.loc_cd)
	};
}
function addLegend() {
	legend.onAdd = function (mymap) {
		var div = L.DomUtil.create('div', 'info newlegend')
		if (compartment=="R"){
			var colors = ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32']
		} else if (compartment=="I"){
			var colors = ['#fff5f0','#fee0d3','#fcbda4','#fc9677','#fb7050','#f14431','#d32020','#ac1016']
		} else if (compartment=="E"){
			var colors = ['#ffffd4','#fef1ba','#fee3a1','#fed384','#febb60','#fea43b','#f78e24','#e9791a']
		} else{
			var colors = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'];
		}
		// loop through our density intervals and generate a label with a colored square for each interval
		div.innerHTML += '<i style="background:#ccc"></i> No Data <br>'
		for (var i = 0; i < grades.length; i++) {
			div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + grades[i] + (grades[i + 1] ? '&ndash;' + (grades[i + 1] - 1) + '<br>' : '+');
		}
		return div;
	};
	legend.addTo(mymap);
}
 
</script>