<link rel="stylesheet" type="text/css" href="assets/plugins/ionslider/ion.rangeSlider.css" />
<link rel="stylesheet" type="text/css" href="assets/plugins/ionslider/ion.rangeSlider.skinModern.css" />

<div id="diseaseSelector" class="panelSelector">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" id="diseaseName" class="btn btn-default xl labeler">Disease Selector</button>
        <button type="button" class="btn btn-default openPanel xl"> <i class="glyphicon glyphicon-modal-window"></i> </button>
    </div>
    <div class="panel-group" id="accordion">
        <div class="panel panel-default padded projectList" id="projectList">
          <div data-template="data-template">
            <div class="panel-heading" role="tab" id="headinga{{ id }}">
                <h4 class="panel-title">
                    <a class="collapsed pTitle" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsea{{ id }}" aria-expanded="false" aria-controls="collapsea{{ id }}">
                    {{ title }}
                    </a>
                </h4>
						</div>
						
            <div id="collapsea{{ id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headinga{{ id }}">
              <div class="panel-body noborder">
                <div class="panel-group" id="accordion{{ id }}">

									<div class="panel panel-inner panel-default"  data-template-for="scenarios">
										<div class="panel-heading" role="tab" id="headingb{{ sid }}">
											<h4 class="panel-title">
												<a class="collapsed sTitle" role="button" data-toggle="collapse" data-parent="#accordion{{ _parent.id }}" href="#collapseb{{ sid }}" aria-expanded="false" aria-controls="collapseb{{ sid }}" >
												<i class="glyphicon glyphicon-chevron-right"></i> {{ stitle }}
												</a>
											</h4>
										</div>
										<div id="collapseb{{ sid }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingb{{ sid }}">
											<div class="list-group">
												<a class="list-group-item indent startSim" rel="S" id="{{ sid }}" name="{{ stitle }} - Susceptible" href="#">Susceptible</a>
												<a class="list-group-item indent startSim" rel="E" id="{{ sid }}" name="{{ stitle }} - Exposed" href="#">Exposed</a>
												<a class="list-group-item indent startSim" rel="I" id="{{ sid }}" name="{{ stitle }} - Infectious" href="#">Infectious</a>
												<a class="list-group-item indent startSim" rel="R" id="{{ sid }}" name="{{ stitle }} - Recovered" href="#">Recovered</a>
											</div>
										</div>
									</div>
                </div>
              </div>
						</div>
						
          </div>  
        </div>
    </div>
</div>

<div id='mapid'></div>

<div id="slider" style="display: none;">
		<button id='play'><i class="fa fa-play-circle fa-3x"></i></button>
		<input id="myRange" type="text" data-type="single" data-step="1" data-from="1" data-slider="true" data-hasgrid="true" />
</div>

<div class="modal-loading">
		<!-- Place at bottom of page -->
		<i class="fa fa-sync fa-spin fa-3x fa-fw margintop200"></i>
		<br><br>
		<p>Please wait. Fetching disease data...</p>
</div>

<script src="assets/plugins/ionslider/ion.rangeSlider.js" ></script>
<script src="assets/plugins/moment/moment.min.js"></script>

<script type="text/javascript">

$(document).ready(function() {
	var xData;
	var PHgeojson;
	$('.modal-loading').hide();
	$('#mapid').css('height', $(window).height()+75 );
	
	$.getScript( "assets/geojson/ph.js" )
		.done(function( script, textStatus ) {
			console.log( textStatus );
			getProjectsData().done(function (result) {
				xData = result;

				console.log(xData);
				//display data using template plugin
				Tempo.prepare("projectList").render(xData);

				playStatus = false;
				playButton = document.getElementById("play");
				$('#play').on('click', function(){
					if (playButton.innerHTML == '<i class="fa fa-play-circle fa-3x"></i>'){
						playButton.innerHTML = '<i class="fa fa-stop-circle fa-3x"></i>';
						playStatus = true;
						playLoop();
					}else{
						playButton.innerHTML = '<i class="fa fa-play-circle fa-3x"></i>';
						playStatus = false;
					}
				});

				$('.openPanel').on('click', function(){
					if($(this).hasClass('clickable')) {
						$('#diseaseSelector .panel-default').slideDown();
						//$('.openPanel').hide('slide',{direction:'left'});
						$('.openPanel').removeClass('clickable');
						$('.openPanel i.glyphicon').removeClass('glyphicon-collapse-down');
						$('.openPanel i.glyphicon').addClass('glyphicon-modal-window');
						$( "#slider" ).hide();
					}
				});
				
				//This activates the slider
				//use the functions to create interactivity on the map
				//the onChange is the best function to use for color changes
				$("#myRange").ionRangeSlider({
					grid: true,
					grid_num: 30,
					grid_snap: true,
					prettify_enabled: true,
					keyboard: true,
				});
				mapslider = $("#myRange").data("ionRangeSlider");
				$('.preloader').hide();

				if( location.hash.indexOf("?") > 0 ) {
					console.log("Has hash URL");
					hash = location.hash;
					h = hash.split("?");
					q = h[1].split('&');
					var aName = q[0].split('=')[1];
					var aID = q[1].split('=')[1];
					var aRel = q[2].split('=')[1];
					sim(aName, aID, aRel);
				}
				
				//prep scenario triggers
				$('a.startSim').on('click', function(e){ 
					//get ID of this button
					var aID = $(this).attr('id');
					//get name of this button
					var aName = $(this).attr('name');
					var aRel = $(this).attr('rel');
					console.log("aName", aName);
					e.preventDefault();
					sim(aName, aID, aRel);
				});
			})
		})
		.fail(function( jqxhr, settings, exception ) {
			$( "div.log" ).text( "Triggered ajaxError handler." );
	});

});

function sim(aName, aID, aRel) {
	$('.modal-loading').show();

	//assign name to the Console bar
	$("#diseaseName").html(aName);
	requestData(aID, aRel);

	mymap.setView(new L.LatLng(11.1, 121.9),8);
	$('#diseaseSelector .panel-default').slideUp();
	
	$('.openPanel').addClass('clickable');
	$('.openPanel i.glyphicon').removeClass('glyphicon-modal-window');
	$('.openPanel i.glyphicon').addClass('glyphicon-collapse-down');
	$( "#slider" ).show();
	
}

//fire map rendering
var dataType, counts, grades, date_length, disease, compartment;
var dataLayer = L.layerGroup();
var osmMapnik = new L.tileLayer.provider("OpenStreetMap.Mapnik");
var stamenTerrain = new L.tileLayer.provider("Stamen.Terrain");
var osmBW = new L.tileLayer.provider("OpenStreetMap.BlackAndWhite");
var stamenToner = new L.tileLayer.provider("Stamen.Toner");
var mapboxTile = new L.tileLayer.provider("MapBox", {
	id: 'jenjereren.16nj7dd6',
	accessToken: 'pk.eyJ1IjoiamVuamVyZXJlbiIsImEiOiJjaXM2ODlkNmcwZDlnMnlvMGswNmpldWUwIn0.eCh8h5prpNCamLH_zbYHoA'
});

var mymap = new L.Map("mapid", {
	center: new L.LatLng(12.4, 122.4),
	zoomControl: false,
	zoom: 5.5,
	minZoom: 2,
	maxZoom: 12,
	layers: [osmBW]
});
var baseLayers = {
	"Stamen Terrain": stamenTerrain,
	"Stamen Toner": stamenToner,
	"Mapbox": mapboxTile,
	"OpenStreetMap": osmMapnik,
	"OpenStreetMap B&W": osmBW
};
var controlLayers = L.control.layers(baseLayers).addTo(mymap);
var legend = L.control({position: 'topright'});
// adds a scale bar to the map in metric and English units
L.control.scale().addTo(mymap);

function playLoop () {
	setTimeout(function () {
		if (playStatus){
			//if (dataType == "STEM"){
				sliderDate = $("#myRange").prop("value");
				var i = counts.time.indexOf(sliderDate);
				if (i<date_length-1){
					/*mapslider.update({
						from: i+1,
					});*/
					updateSlider(i+1);
					i++;
					playLoop();
				} else {
					/*mapslider.update({
						from: 0,
					});*/
					updateSlider(0);
					playButton = document.getElementById("play");
					playButton.innerHTML = '<i class="fa fa-play-circle fa-3x"></i>';
				}
			//}
		}
	}, 500)
}

//render STEM compartment data
function requestData(id, type) {
	//remove overlayed layers and popups
	compartment = type;
	dataLayer.clearLayers();
	mymap.closePopup();
	mapData = "";
	var mapbody = {
		//'region': 6, //removed because it is not used
		//'province': 'iloilo', //removed because it is not used
		'scenario_id': id,
		'type': type
	}
	
	var mapGetData = $.get("http://104.236.3.75/fassster-api/public/api/simulation/map",
	mapbody, function(mdata) {
				if(mdata) {
						console.log(mdata);
						mapData = mdata;
				}
		}, "json");

	mapGetData.done(function() {
		counts = {};
		cs = mapData.data.data;
		jQuery.each(cs, function(index, itemData) {
			counts[itemData.location.toUpperCase()] = itemData.count;
		});
		counts['time'] = mapData.data.dates;
		
		grades = mapData.data.grades;
		date_length = mapData.data.date_length;
		console.log(counts);
		updateSlider(0);
		//PHgeojson.setStyle(STEMstyle);
		renderSTEMPH();
		addLegend();

		$('.modal-loading').hide();
	});

}

function updateSlider(i) {
	// Call sliders update method with any params
	mapslider.update({
		values: counts.time,
		from: i,
		onStart: function (data) {
		//console.log(data);
		},
		onChange: function (data) {
			dataLayer.getLayers()[0].setStyle(STEMstyle);
			//update popup values
			dataLayer.getLayers()[0].eachLayer(function (layer) {
				sliderDate = $("#myRange").prop("value");
				slidervalue = counts.time.indexOf(sliderDate);
				if (counts[layer.feature.properties.loc_cd] != null){
					var count = counts[layer.feature.properties.loc_cd][slidervalue];
				}
				//format popup text
				var textList = layer.feature.properties.loc_cd.split("_");
				var msg = "<b>Province: </b>" + textList[1] + "<br/>";
				msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
				msg += "<b>Count: </b>";
				msg += count ? count : (count==0) ? count : "No Data";
				layer._popup.setContent(msg);
			});
			//PHgeojson.setStyle(STEMstyle);
		},
		onFinish: function (data) {
			//console.log(data);
		},
		onUpdate: function (data) {
			//console.log(data);
			if (dataLayer.getLayers()[0]){
				dataLayer.getLayers()[0].setStyle(STEMstyle);
				//update popup values
				dataLayer.getLayers()[0].eachLayer(function (layer) {
					sliderDate = $("#myRange").prop("value");
					slidervalue = counts.time.indexOf(sliderDate);
					if (counts[layer.feature.properties.loc_cd] != null){
						var count = counts[layer.feature.properties.loc_cd][slidervalue];
					}
					//format popup text
					var textList = layer.feature.properties.loc_cd.split("_");
					var msg = "<b>Province: </b>" + textList[1] + "<br/>";
					msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
					msg += "<b>Count: </b>";
					msg += count ? count : (count==0) ? count : "No Data";
					layer._popup.setContent(msg);
				});
			}
		}
	});
}
function renderSTEMPH(){
	/** PHgeojson is now coming from ph.js **/
	var geojsonlayer = {};
	STEMgeojsonlayer = L.geoJson(
		PHgeojson, { onEachFeature: onEachSTEMFeature, style: STEMstyle }
	);
	dataLayer.clearLayers();
	mymap.closePopup();
	dataLayer.addLayer(STEMgeojsonlayer);
	dataLayer.addTo(mymap);

	function onEachSTEMFeature(feature, layer) {
		var STEMpopup = L.popup();
		sliderDate = $("#myRange").prop("value"); console.log(sliderDate);
		slidervalue = counts.time.indexOf(sliderDate);
		if (counts[feature.properties.loc_cd] != null){
			var count = counts[feature.properties.loc_cd][slidervalue];
		}
		//format popup text
		var textList = layer.feature.properties.loc_cd.split("_");
		var msg = "<b>Province: </b>" + textList[1] + "<br/>";
		msg += "<b>Municipality: </b>" + textList[0] + "<br/>";
		msg += "<b>Count: </b>";
		msg += count ? count : (count==0) ? count : "No Data";
		layer.bindPopup(msg);
	}
}

// get color depending on count
function STEMgetColor(mun) {
	sliderDate = $("#myRange").prop("value");
	slidervalue = counts.time.indexOf(sliderDate);
	//console.log(value);
	if (counts[mun] != null){
		var count = counts[mun][slidervalue];
	}
	if (compartment == "R"){
		return count >= grades[7] ? '#005a32' :
		count >= grades[6] ? '#238b45' :
		count >= grades[5] ? '#41ab5d' :
		count >= grades[4] ? '#74c476' :
		count >= grades[3] ? '#a1d99b' :
		count >= grades[2] ? '#c7e9c0' :
		count >= grades[1] ? '#e5f5e0' :
		count >= grades[0] ? '#f7fcf5' :
		'#ccc';
	} else if (compartment == "I"){
		return count >= grades[7] ? '#ac1016' :
		count >= grades[6] ? '#d32020' :
		count >= grades[5] ? '#f14431' :
		count >= grades[4] ? '#fb7050' :
		count >= grades[3] ? '#fc9677' :
		count >= grades[2] ? '#fcbda4' :
		count >= grades[1] ? '#fee0d3' :
		count >= grades[0] ? '#fff5f0' :
		'#ccc';
	} else if (compartment == "E"){
		return count >= grades[7] ? '#e9791a' :
		count >= grades[6] ? '#f78e24' :
		count >= grades[5] ? '#fea43b' :
		count >= grades[4] ? '#febb60' :
		count >= grades[3] ? '#fed384' :
		count >= grades[2] ? '#fee3a1' :
		count >= grades[1] ? '#fef1ba' :
		count >= grades[0] ? '#ffffd4' :
		'#ccc';
	} else if (compartment == "Tweets"){
		return count >= grades[7] ? '#084594' :
		count >= grades[6] ? '#2171b5' :
		count >= grades[5] ? '#4292c6' :
		count >= grades[4] ? '#6baed6' :
		count >= grades[3] ? '#9ecae1' :
		count >= grades[2] ? '#c6dbef' :
		count >= grades[1] ? '#deebf7' :
		count >= grades[0] ? '#f7fbff' :
		'#ccc';
	} else{
		return count >= grades[7] ? '#084594' :
		count >= grades[6] ? '#2171b5' :
		count >= grades[5] ? '#4292c6' :
		count >= grades[4] ? '#6baed6' :
		count >= grades[3] ? '#9ecae1' :
		count >= grades[2] ? '#c6dbef' :
		count >= grades[1] ? '#deebf7' :
		count >= grades[0] ? '#f7fbff' :
		'#ccc';
	}
}

function STEMstyle(feature) {
	return {
		weight: 0.7,
		opacity: 0.7,
		color: 'gray',
		fillOpacity: 0.75,
		fillColor: STEMgetColor(feature.properties.loc_cd)
	};
}

function addLegend() {
	legend.onAdd = function (mymap) {
		var div = L.DomUtil.create('div', 'info newlegend')
		if (compartment=="R"){
			var colors = ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32']
		} else if (compartment=="I"){
			var colors = ['#fff5f0','#fee0d3','#fcbda4','#fc9677','#fb7050','#f14431','#d32020','#ac1016']
		} else if (compartment=="E"){
			var colors = ['#ffffd4','#fef1ba','#fee3a1','#fed384','#febb60','#fea43b','#f78e24','#e9791a']
		} else{
			var colors = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'];
		}
		// loop through our density intervals and generate a label with a colored square for each interval
		div.innerHTML += '<i style="background:#ccc"></i> No Data <br>'
		for (var i = 0; i < grades.length; i++) {
			div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + grades[i] + (grades[i + 1] ? '&ndash;' + (grades[i + 1] - 1) + '<br>' : '+');
		}
		return div;
	};
	legend.addTo(mymap);
}

function getProjectsData() {
	var deferred = new $.Deferred();

	var body = {};
	cData = [];
	cScenario = [];
	complete = 0;
	
	//let us check token
	token = checkToken( $.session.get('userToken') );

	//let us get all projects by page
	$.ajax({
			url: "http://104.236.3.75/fassster-api/public/api/projects/get",
			data: body, 
			type: "get",
			dataType: "json",
			async: false,
			headers: { 
							"Authorization": "Bearer " + token
					},
			success: function(data, textStatus, jqXHR){
							console.log('OK!');
					},
			error: function(jqXHR, textStatus, errorThrown){
							console.log(textStatus);
					}
			})
			.done(function(data) {
					if(data && data.success == true) {
							$.each(data.data, function(i, item) {
									/*cData.push({
										id: i,
										title: item
									});*/
									var key = i;
									var value = item;
									//get scenarios for this project
									//$.each(cData, function(i, item){
										var sbody = {};
										$.ajax({
											url: "http://104.236.3.75/fassster-api/public/api/scenarios/get?project_id="+i,
											data: sbody, 
											type: "get",
											dataType: "json",
											async: false,
											headers: { 
															"Authorization": "Bearer " + token
													},
											success: function(sdata, textStatus, jqXHR){
															console.log('OK!');
													},
											error: function(jqXHR, textStatus, errorThrown){
															console.log(textStatus);
													}
											})
											.done(function(sdata) {
												if(sdata && sdata.success == true) {
													//console.log("sdata",sdata.data);
													$.each(sdata.data, function(s, sitem) {
														cScenario.push({
															sid: s,
															stitle: sitem
														});
													});
												}
												cData.push({
													id: key,
													title: value,
													scenarios: cScenario
												})
												cScenario = [];
										});
									//});
							});
					}
					deferred.resolve(cData);
			})
			.fail(function() {
				swal("Oops!", "ERROR: Cannot retrieve data! Seems like the WebService is down. Please try again later. Or you can contact FASSSTER.", "error");
				location.reload();
			});
			return deferred.promise();
}
 
</script>